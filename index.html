/* =========================================
   POART NOTARY ENGINE v4.4 & SECURITY CORE
   ========================================= */

(async function () {
  const SUPABASE_URL = "https://immdfdvrwqcvgmflbgdr.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltbWRmZHZyd3FjdmdtZmxiZ2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NzU0MTgsImV4cCI6MjA4MzQ1MTQxOH0.MN05h2FLVFb14P9Oi0y3g3euqZjzGdVslJay6aQ1HkE";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const sealBtn = document.getElementById("sealBtn");
  const artFile = document.getElementById("artFile");
  const userPhoto = document.getElementById("userPhoto");
  const creatorName = document.getElementById("creatorName");
  const artTitle = document.getElementById("artTitle");
  const statusBox = document.getElementById("statusBox");

  const artDrop = document.getElementById("artDrop");
  const photoDrop = document.getElementById("photoDrop");
  const artMeta = document.getElementById("artMeta");
  const photoMeta = document.getElementById("photoMeta");

  const artPreview = document.getElementById("artPreview");
  const photoPreview = document.getElementById("photoPreview");
  const artPreviewEmpty = document.getElementById("artPreviewEmpty");
  const photoPreviewEmpty = document.getElementById("photoPreviewEmpty");

  const previewSection = document.getElementById("previewSection");
  const certPreview = document.getElementById("certPreview");
  const downloadPNG = document.getElementById("downloadPNG");
  const downloadJSON = document.getElementById("downloadJSON");
  const downloadPDF = document.getElementById("downloadPDF");
  
  // Live Preview Elements (HTML'de varsa √ßalƒ±≈üƒ±r yoksa hata vermez)
  const liveIPPreview = document.getElementById("liveIPPreview");
  const tableMaskedIP = document.getElementById("tableMaskedIP");
  const tablePublicIP = document.getElementById("tablePublicIP");
  const tableMaskedLoc = document.getElementById("tableMaskedLoc");
  const tablePublicLoc = document.getElementById("tablePublicLoc");

  let currentRecord = null;
  let currentArtDataUrl = null;
  let currentPhotoDataUrl = null;
  let cachedIPData = null;

  // Get selected visibility
  function getVisibility() {
    const checked = document.querySelector('input[name="visibility"]:checked');
    return checked ? checked.value : 'private';
  }

  // Fetch and cache IP on load
  async function fetchIPData() {
    try {
      const res = await fetch("https://ipapi.co/json/");
      cachedIPData = await res.json();
      // Update live preview and table
      if (cachedIPData && cachedIPData.ip) {
        const maskedIP = maskIP(cachedIPData.ip);
        const city = cachedIPData.city || 'Bilinmiyor';
        const country = cachedIPData.country_name || 'Bilinmiyor';
        
        // Update IP displays
        if(liveIPPreview) liveIPPreview.textContent = maskedIP;
        if(tableMaskedIP) tableMaskedIP.textContent = maskedIP;
        if(tablePublicIP) tablePublicIP.textContent = maskedIP;
        
        // Update location displays
        if(tableMaskedLoc) tableMaskedLoc.textContent = `*** / ${country}`;
        if(tablePublicLoc) tablePublicLoc.textContent = `${city}, ${country}`;
      }
    } catch (e) {
      console.warn("IP fetch failed:", e);
      cachedIPData = null;
    }
  }
  fetchIPData();

  // UI helpers
  function setStatus(html, kind = "info") {
    if(!statusBox) return;
    statusBox.style.display = "block";
    const color = kind === "error" ? "#dc2626" : (kind === "ok" ? "#059669" : "#4b5563");
    statusBox.innerHTML = `<span style="color:${color};">${html}</span>`;
  }

  function setDropMeta(el, file) {
    if (!file) { el.textContent = ""; return; }
    const sizeMb = (file.size / (1024 * 1024)).toFixed(2);
    el.textContent = `${file.name} ‚Ä¢ ${sizeMb} MB`;
  }

  function bindDropZone(zoneEl, inputEl, metaEl, onFile) {
    if(!zoneEl) return;
    zoneEl.addEventListener("click", () => inputEl.click());
    zoneEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") inputEl.click();
    });

    ["dragenter","dragover"].forEach(evt => {
      zoneEl.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoneEl.classList.add("is-over");
      });
    });
    ["dragleave","drop"].forEach(evt => {
      zoneEl.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoneEl.classList.remove("is-over");
      });
    });
    zoneEl.addEventListener("drop", (e) => {
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!file) return;
      inputEl.files = e.dataTransfer.files;
      setDropMeta(metaEl, file);
      onFile(file);
    });

    inputEl.addEventListener("change", () => {
      const file = inputEl.files && inputEl.files[0];
      setDropMeta(metaEl, file);
      onFile(file);
    });
  }

  bindDropZone(photoDrop, userPhoto, photoMeta, async (file) => {
    if (!file) return;
    if (!file.type.startsWith("image/")) {
      photoPreview.style.display = "none";
      photoPreviewEmpty.textContent = "Sadece g√∂rsel kabul edilir";
      photoPreviewEmpty.style.display = "block";
      return;
    }
    const url = URL.createObjectURL(file);
    photoPreview.src = url;
    photoPreview.style.display = "block";
    photoPreviewEmpty.style.display = "none";
  });

  bindDropZone(artDrop, artFile, artMeta, async (file) => {
    if (!file) return;
    if (file.type.startsWith("image/")) {
      const url = URL.createObjectURL(file);
      artPreview.src = url;
      artPreview.style.display = "block";
      artPreviewEmpty.style.display = "none";
    } else {
      artPreview.style.display = "none";
      artPreviewEmpty.textContent = "G√∂rsel deƒüilse √∂nizleme yok";
      artPreviewEmpty.style.display = "block";
    }
  });

  // Crypto
  async function digest(buffer, algo) {
    const hashBuffer = await crypto.subtle.digest(algo, buffer);
    return Array.from(new Uint8Array(hashBuffer)).map((b) => b.toString(16).padStart(2, "0")).join("");
  }

  function maskIP(ip) {
    if (!ip) return "***.***.***.***";
    const parts = ip.split('.');
    if (parts.length === 4) return `${parts[0]}.${parts[1]}.***.***`;
    return ip.substring(0, 6) + "****";
  }

  function maskLoc(city, country) {
    return `*** / ${country || "Bilinmiyor"}`;
  }

  async function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("FileReader failed"));
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }

  function formatDate(iso) {
    try {
      const d = new Date(iso);
      return d.toLocaleDateString('tr-TR') + ' ' + d.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
    } catch {
      return iso;
    }
  }

  // Generate QR
  async function generateQR(text) {
    const canvas = document.createElement("canvas");
    await QRCode.toCanvas(canvas, text, {
      width: 110,
      color: { dark: "#065f46", light: "#ffffff" }
    });
    return canvas.toDataURL("image/png");
  }

  // Generate Certificate HTML
  async function generateCertHTML(record, artDataUrl, photoDataUrl, qrDataUrl, visibility) {
    const photoHTML = photoDataUrl ? `
      <div>
        <div class="cert-photo-frame">
          <img src="${photoDataUrl}" alt="User">
        </div>
        <div class="cert-photo-label">Fotoƒüraf</div>
      </div>
    ` : '';

    const artHTML = artDataUrl ? `
      <div class="cert-artwork-main">
        <img src="${artDataUrl}" alt="Artwork">
      </div>
    ` : `
      <div class="cert-artwork-main" style="min-height: 200px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f9fafb, #f0fdf4);">
        <div style="text-align: center; color: #6b7280;">
          <div style="font-size: 48px; margin-bottom: 8px;">üìÑ</div>
          <div style="font-weight: 700;">${record.title}</div>
        </div>
      </div>
    `;

    // Visibility-based info display
    let extraInfoHTML = '';
    
    if (visibility === 'public') {
      extraInfoHTML = `
        <div class="cert-info-item">
          <div class="cert-info-label">Konum</div>
          <div class="cert-info-value">${record.location_data || 'Belirtilmedi'}</div>
        </div>
        <div class="cert-info-item">
          <div class="cert-info-label">IP (Maskeli)</div>
          <div class="cert-info-value">${record.origin_ip}</div>
        </div>
      `;
    } else if (visibility === 'masked') {
      extraInfoHTML = `
        <div class="cert-info-item">
          <div class="cert-info-label">Konum</div>
          <div class="cert-info-value">${record.location_data}</div>
        </div>
        <div class="cert-info-item">
          <div class="cert-info-label">IP (Maskeli)</div>
          <div class="cert-info-value">${record.origin_ip}</div>
        </div>
      `;
    }

    const localBadge = visibility === 'private' ? '<span class="cert-local-badge">üîí YEREL</span>' : '';

    const visibilityLabels = {
      'private': '√ñzel (Private)',
      'masked': 'Maskeli (Masked)',
      'public': 'Herkese A√ßƒ±k (Public)'
    };

    return `
      <div class="cert-frame">
        <div class="cert-header">
          <div class="cert-logo">POART PROTOCOL</div>
          <h2 class="cert-title">Dƒ∞Jƒ∞TAL NOTER SERTƒ∞Fƒ∞KASI ${localBadge}</h2>
          <div class="cert-subtitle">ƒ∞lhan Art Gallery tarafƒ±ndan verilmi≈ütir</div>
        </div>

        <div class="cert-body">
          <div class="cert-photos">
            ${photoHTML}
            ${artHTML}
            <div>
              <div class="cert-qr">
                <img src="${qrDataUrl}" style="width: 100%; height: auto;" alt="QR">
              </div>
              <div class="cert-photo-label">Doƒürula</div>
            </div>
          </div>

          <div class="cert-info-panel">
            <div class="cert-info-title">Sertifika Bilgileri</div>
            <div class="cert-info-grid">
              <div class="cert-info-item">
                <div class="cert-info-label">Eser Adƒ±</div>
                <div class="cert-info-value">${record.title}</div>
              </div>
              <div class="cert-info-item">
                <div class="cert-info-label">Sanat√ßƒ±</div>
                <div class="cert-info-value">${record.creator}</div>
              </div>
              <div class="cert-info-item">
                <div class="cert-info-label">Sertifika ID</div>
                <div class="cert-info-value">${record.cert_id}</div>
              </div>
              <div class="cert-info-item">
                <div class="cert-info-label">Tarih</div>
                <div class="cert-info-value">${formatDate(record.created_at)}</div>
              </div>
              <div class="cert-info-item">
                <div class="cert-info-label">G√∂r√ºn√ºrl√ºk</div>
                <div class="cert-info-value">${visibilityLabels[visibility] || visibility}</div>
              </div>
              ${extraInfoHTML}
            </div>
          </div>

          <div class="cert-hash-panel">
            <div class="cert-hash-title">üîê Kriptografik Parmak ƒ∞zleri</div>
            <div style="margin-bottom: 12px;">
              <div style="font-size: 10px; font-weight: 800; color: #6b7280; margin-bottom: 5px;">SHA-256:</div>
              <div class="cert-hash-value">${record.sha256}</div>
            </div>
            <div>
              <div style="font-size: 10px; font-weight: 800; color: #6b7280; margin-bottom: 5px;">SHA-512:</div>
              <div class="cert-hash-value">${record.sha512}</div>
            </div>
          </div>

          <div class="cert-disclaimer">
            ${visibility === 'private' 
              ? 'Bu sertifika yalnƒ±zca tarayƒ±cƒ±nƒ±zda olu≈üturulmu≈ütur ve sunucuya kaydedilmemi≈ütir.'
              : 'This certificate is digitally notarized and cryptographically sealed for the PoArt Protocol.'}
          </div>

          <div class="cert-footer">
            <div class="cert-stamp">ONAYLANDI<br>‚úì</div>
          </div>
        </div>
      </div>
    `;
  }

  // Main seal function
  if(sealBtn) {
      sealBtn.addEventListener("click", async () => {
        if (!artFile.files.length) return alert("L√ºtfen √∂nce bir eser se√ßin!");

        previewSection.style.display = "none";
        certPreview.innerHTML = "";

        const visibility = getVisibility();

        try {
          sealBtn.disabled = true;
          setStatus("‚è≥ ƒ∞≈üleniyor... Hash hesaplanƒ±yor...", "info");

          const file = artFile.files[0];
          const buffer = await file.arrayBuffer();

          const sha256 = await digest(buffer, "SHA-256");
          const sha512 = await digest(buffer, "SHA-512");

          // Prepare location/IP data based on visibility
          let ip = "***.***.***.***";
          let loc = "Gizli";
          
          if (visibility !== 'private' && cachedIPData) {
            if (visibility === 'public') {
              ip = maskIP(cachedIPData.ip);
              loc = `${cachedIPData.city || 'Bilinmiyor'}, ${cachedIPData.country_name || 'Bilinmiyor'}`;
            } else if (visibility === 'masked') {
              ip = maskIP(cachedIPData.ip);
              loc = maskLoc(cachedIPData.city, cachedIPData.country_name);
            }
          }

          const record = {
            cert_id: "POART-" + Math.random().toString(36).substring(2, 10).toUpperCase(),
            title: artTitle.value || "ƒ∞simsiz",
            creator: creatorName.value || "Bilinmiyor",
            sha256: sha256,
            sha512: sha512,
            visibility: visibility,
            device_info: visibility === 'public' ? navigator.userAgent : "Gizli",
            location_data: loc,
            origin_ip: ip,
            created_at: new Date().toISOString()
          };

          currentRecord = record;

          if (file.type.startsWith("image/")) {
            currentArtDataUrl = await fileToDataUrl(file);
          } else {
            currentArtDataUrl = null;
          }

          const userFile = userPhoto.files[0];
          if (userFile && userFile.type.startsWith("image/")) {
            currentPhotoDataUrl = await fileToDataUrl(userFile);
          } else {
            currentPhotoDataUrl = null;
          }

          // Only save to Supabase if NOT private
          let supabaseSuccess = false;
          if (visibility !== 'private') {
            setStatus("üíæ Supabase'e kaydediliyor...", "info");
            try {
              const { error } = await sb.from("manifests").insert([record]);
              if (error) throw error;
              console.log("‚úÖ Supabase insert SUCCESS");
              supabaseSuccess = true;
            } catch (e) {
              console.error("‚ùå Supabase insert FAILED:", e);
              setStatus(`‚ö†Ô∏è Kayƒ±t hatasƒ±, sertifika yine de √ºretiliyor.`, "info");
            }
          }

          const qrDataUrl = await generateQR(`https://ilhanart.org/verify?id=${record.cert_id}`);
          setStatus("üìú Sertifika olu≈üturuluyor...", "info");
          const certHTML = await generateCertHTML(record, currentArtDataUrl, currentPhotoDataUrl, qrDataUrl, visibility);
          certPreview.innerHTML = certHTML;
          previewSection.style.display = "block";

          if (visibility === 'private') {
            setStatus("‚úÖ Sertifika hazƒ±r! (√ñzel Mod)", "ok");
          } else if (supabaseSuccess) {
            setStatus("‚úÖ Sertifika hazƒ±r ve kaydedildi!", "ok");
          } else {
            setStatus("‚ö†Ô∏è Sertifika hazƒ±r (Kayƒ±t ba≈üarƒ±sƒ±z).", "ok");
          }
        } catch (err) {
          console.error("Main error:", err);
          setStatus(`‚ùå Hata: ${err.message}`, "error");
        } finally {
          sealBtn.disabled = false;
        }
      });
  }

  // Download Handlers
  if(downloadPNG) {
      downloadPNG.addEventListener("click", async () => {
        if (!currentRecord) return;
        try {
          setStatus("üñºÔ∏è PNG olu≈üturuluyor...", "info");
          const certElement = certPreview.querySelector('.cert-frame');
          const canvas = await html2canvas(certElement, { 
            scale: 2, 
            useCORS: true, 
            backgroundColor: '#ffffff',
            logging: false
          });
          const link = document.createElement("a");
          link.download = `${currentRecord.cert_id}_Certificate.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();
          setStatus("‚úÖ PNG indirildi!", "ok");
        } catch (e) {
          console.error(e);
          setStatus("‚ùå PNG hatasƒ±", "error");
        }
      });
  }

  if(downloadJSON) {
      downloadJSON.addEventListener("click", () => {
        if (!currentRecord) return;
        const jsonData = {
          ...currentRecord,
          verification_url: `https://ilhanart.org/verify?id=${currentRecord.cert_id}`
        };
        const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: "application/json" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${currentRecord.cert_id}_Data.json`;
        link.click();
        setStatus("‚úÖ JSON indirildi!", "ok");
      });
  }

  if(downloadPDF) {
      downloadPDF.addEventListener("click", async () => {
        if (!currentRecord) return;
        try {
          setStatus("üìÑ PDF olu≈üturuluyor...", "info");
          const { jsPDF } = window.jspdf;
          const certElement = certPreview.querySelector('.cert-frame');
          const canvas = await html2canvas(certElement, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
          const imgData = canvas.toDataURL("image/png");
          const pdf = new jsPDF("p", "mm", "a4");
          const imgWidth = pdf.internal.pageSize.getWidth() - 20;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
          pdf.save(`${currentRecord.cert_id}_Certificate.pdf`);
          setStatus("‚úÖ PDF indirildi!", "ok");
        } catch (e) {
          console.error(e);
          setStatus("‚ùå PDF hatasƒ±", "error");
        }
      });
  }

})();


/* -----------------------------------------------------------
   üõ°Ô∏è POART INTEGRITY CHECKER MODULE
   Bu kod kendi kendini (app.js) okur ve hash'ler.
   ----------------------------------------------------------- */
async function verifySystemIntegrity() {
    const TARGET_FILE = 'app.js'; // DO NOT CHANGE THIS

    const displayElement = document.getElementById('hash-display');
    if(!displayElement) return;

    try {
        const response = await fetch(TARGET_FILE);
        if (!response.ok) throw new Error(`Dosya okunamadƒ±: ${TARGET_FILE}`);

        const buffer = await response.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-512', buffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        displayElement.innerText = hashHex; 
        console.log(`[PoArt Security] System Hash: ${hashHex}`);

    } catch (error) {
        console.error("Integrity Check Failed:", error);
        displayElement.innerText = "‚ö†Ô∏è SYSTEM VERIFICATION FAILED (Localhost or Fetch Error)";
        displayElement.style.color = "#ff3b3b";
    }
}
window.addEventListener('load', verifySystemIntegrity);
