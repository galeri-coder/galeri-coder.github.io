<!-- ‚úÖ DIGITAL NOTARY ‚Äî PREMIUM EDITION v4.1 (FIXED) -->
<div id="notaryApp" class="dn-wrap">
  <div class="dn-head">
    <h1 class="dn-title">Dƒ∞Jƒ∞TAL NOTER</h1>
    <p class="dn-sub">Eserinizi y√ºkleyin, kriptografik olarak m√ºh√ºrleyin ve resmi sertifikanƒ±zƒ± alƒ±n.</p>
  </div>

  <!-- Drag & Drop -->
  <div class="dn-grid">
    <div>
      <label class="dn-label">Fotoƒürafƒ±nƒ±z</label>
      <div id="photoDrop" class="dn-drop" role="button" tabindex="0">
        <div class="dn-drop-title">S√ºr√ºkle bƒ±rak</div>
        <div class="dn-drop-sub">veya tƒ±klayƒ±p se√ßin</div>
        <div id="photoMeta" class="dn-drop-meta"></div>
      </div>
      <input type="file" id="userPhoto" accept="image/*" class="dn-hidden-input" />
    </div>

    <div>
      <label class="dn-label">Eser Dosyasƒ±</label>
      <div id="artDrop" class="dn-drop" role="button" tabindex="0">
        <div class="dn-drop-title">S√ºr√ºkle bƒ±rak</div>
        <div class="dn-drop-sub">veya tƒ±klayƒ±p se√ßin</div>
        <div id="artMeta" class="dn-drop-meta"></div>
      </div>
      <input type="file" id="artFile" accept="image/*,.pdf,.mp4" class="dn-hidden-input" />
    </div>
  </div>

  <!-- Quick previews -->
  <div class="dn-grid" style="margin-top:-6px;">
    <div class="dn-preview-card">
      <div class="dn-preview-label">Fotoƒüraf √ñnizleme</div>
      <img id="photoPreview" class="dn-preview-img" alt="" style="display:none;" />
      <div id="photoPreviewEmpty" class="dn-preview-empty">Hen√ºz se√ßilmedi</div>
    </div>
    <div class="dn-preview-card">
      <div class="dn-preview-label">Eser √ñnizleme</div>
      <img id="artPreview" class="dn-preview-img" alt="" style="display:none;" />
      <div id="artPreviewEmpty" class="dn-preview-empty">G√∂rsel deƒüilse √∂nizleme olmaz</div>
    </div>
  </div>

  <!-- Metadata -->
  <div class="dn-grid">
    <div>
      <label class="dn-label">√úretici / Sanat√ßƒ± Adƒ±</label>
      <input type="text" id="creatorName" placeholder="Sanat√ßƒ± adƒ±nƒ± girin" class="dn-input" />
    </div>
    <div>
      <label class="dn-label">Eser Ba≈ülƒ±ƒüƒ±</label>
      <input type="text" id="artTitle" placeholder="Eser ba≈ülƒ±ƒüƒ±nƒ± girin" class="dn-input" />
    </div>
  </div>

  <!-- Visibility -->
  <div class="dn-block">
    <label class="dn-label">G√∂r√ºn√ºrl√ºk Se√ßenekleri</label>
    <select id="visibility" class="dn-select">
      <option value="private">üîí √ñzel (yalnƒ±zca siz)</option>
      <option value="masked">üï∂Ô∏è Maskeli Herkese A√ßƒ±k (IP & konum maskeli)</option>
      <option value="public">üåç Herkese A√ßƒ±k (herkes g√∂rebilir)</option>
    </select>
  </div>

  <!-- Mask Option -->
  <label class="dn-check">
    <input type="checkbox" id="maskOption" />
    Sertifikada IP adresi ve konum <b>maskelensin</b>.
  </label>

  <button id="sealBtn" class="dn-btn">ü™∂ M√úH√úRLE & SERTƒ∞Fƒ∞KA OLU≈ûTUR</button>

  <div id="statusBox" class="dn-status" style="display:none;"></div>

  <!-- Certificate Preview & Download Options -->
  <div id="previewSection" class="dn-preview-section" style="display:none;">
    <div class="dn-preview-head">
      <div class="dn-preview-title">üìú Sertifika Hazƒ±r</div>
      <div class="dn-preview-actions">
        <button id="downloadPNG" class="dn-mini-btn" type="button">üñºÔ∏è PNG</button>
        <button id="downloadJSON" class="dn-mini-btn" type="button">üíæ JSON</button>
        <button id="downloadPDF" class="dn-mini-btn" type="button">üìÑ PDF</button>
      </div>
    </div>
    <div id="certPreview" class="dn-cert-container"></div>
  </div>
</div>

<canvas id="certCanvas" style="display:none;"></canvas>

<style>
  .dn-wrap{
    max-width: 880px;
    margin: 0 auto;
    padding: 46px;
    border-radius: 26px;
    background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 45%, #ecfdf5 100%);
    box-shadow: 0 14px 55px rgba(2, 6, 23, 0.08);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    border: 1px solid rgba(16,185,129,0.16);
    backdrop-filter: blur(10px);
  }
  .dn-head{ text-align:center; margin-bottom: 28px; }
  .dn-title{
    font-weight: 950;
    font-size: 34px;
    color: #064e3b;
    letter-spacing: -0.03em;
    margin: 0 0 8px 0;
  }
  .dn-sub{ margin: 0; color: #475569; font-size: 15px; line-height: 1.5; }
  .dn-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    margin-bottom: 18px;
  }
  .dn-block{ margin-bottom: 18px; }
  .dn-label{ font-weight: 800; font-size: 13px; color: #0f172a; margin-bottom: 8px; display:block; }
  .dn-input, .dn-select{
    width: 100%;
    padding: 12px 12px;
    border: 1.8px solid rgba(148,163,184,0.55);
    border-radius: 14px;
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    outline: none;
    transition: box-shadow .2s ease, border-color .2s ease;
    font-size: 14px;
  }
  .dn-input:focus, .dn-select:focus{
    border-color: rgba(16,185,129,0.75);
    box-shadow: 0 0 0 4px rgba(16,185,129,0.12);
  }

  .dn-drop{
    border: 2px dashed rgba(16,185,129,0.35);
    background: linear-gradient(135deg, rgba(236,253,245,0.85), rgba(241,245,249,0.85));
    border-radius: 16px;
    padding: 16px 14px;
    cursor: pointer;
    user-select:none;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    min-height: 86px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    gap: 6px;
  }
  .dn-drop:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(2,6,23,0.06); }
  .dn-drop.is-over{ border-color: rgba(6,78,59,0.65); box-shadow: 0 0 0 4px rgba(16,185,129,0.10); }
  .dn-drop-title{ font-weight: 900; color:#064e3b; }
  .dn-drop-sub{ color:#64748b; font-size: 13px; }
  .dn-drop-meta{ color:#0f172a; font-size: 12px; font-weight: 700; margin-top: 2px; }

  .dn-hidden-input{ display:none; }

  .dn-preview-card{
    border: 1px solid rgba(148,163,184,0.45);
    border-radius: 16px;
    background: linear-gradient(180deg, #ffffff, #f8fafc);
    padding: 12px;
    min-height: 140px;
  }
  .dn-preview-label{ font-weight: 900; color:#0f172a; font-size: 12px; margin-bottom: 10px; }
  .dn-preview-img{ width: 100%; height: 96px; object-fit: cover; border-radius: 12px; border: 1px solid rgba(148,163,184,0.45); }
  .dn-preview-empty{ color:#64748b; font-size: 12px; padding: 26px 0 0; text-align:center; }

  .dn-check{
    display:flex;
    align-items:center;
    gap: 10px;
    font-size: 13px;
    margin: 12px 0 18px;
    color: #064e3b;
    background: linear-gradient(135deg, rgba(236,253,245,0.9), rgba(241,245,249,0.9));
    border: 1px solid rgba(16,185,129,0.14);
    padding: 12px 14px;
    border-radius: 14px;
  }

  .dn-btn{
    width: 100%;
    padding: 16px 28px;
    border: none;
    border-radius: 16px;
    background: linear-gradient(135deg, #16a34a, #047857, #0f766e);
    color: white;
    font-weight: 950;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 14px 36px rgba(16,185,129,0.30);
    transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
  }
  .dn-btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
  .dn-btn:disabled{ opacity: .68; cursor:not-allowed; transform:none; }

  .dn-status{ text-align:center; margin-top: 14px; color: #475569; font-size: 14px; font-weight: 600; }

  .dn-preview-section{
    margin-top: 24px;
    border-radius: 18px;
    border: 2px solid rgba(16,185,129,0.3);
    background: white;
    overflow:hidden;
  }
  .dn-preview-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding: 14px 16px;
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    border-bottom: 2px solid rgba(16,185,129,0.2);
  }
  .dn-preview-title{ font-weight: 950; color:#064e3b; font-size: 15px; }
  .dn-preview-actions{ display:flex; gap: 8px; }
  .dn-mini-btn{
    padding: 9px 14px;
    border-radius: 10px;
    border: 1.5px solid rgba(16,185,129,0.4);
    background: white;
    cursor:pointer;
    font-weight: 800;
    font-size: 12px;
    color:#047857;
    transition: all 0.2s;
  }
  .dn-mini-btn:hover{ 
    background: #ecfdf5;
    box-shadow: 0 4px 12px rgba(16,185,129,0.15);
    transform: translateY(-1px);
  }

  .dn-cert-container{
    padding: 32px;
    background: white;
  }

  /* Certificate Styles */
  .cert-frame{
    max-width: 800px;
    margin: 0 auto;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 3px solid #064e3b;
    border-radius: 20px;
    padding: 0;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.12);
  }

  .cert-header{
    background: linear-gradient(135deg, #064e3b 0%, #047857 50%, #059669 100%);
    padding: 32px 24px;
    text-align: center;
    position: relative;
  }

  .cert-header::after{
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 8px;
    background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7, #34d399, #10b981);
  }

  .cert-logo{
    font-family: 'Georgia', serif;
    font-size: 14px;
    font-weight: 700;
    color: #a7f3d0;
    letter-spacing: 3px;
    margin-bottom: 12px;
  }

  .cert-title{
    font-family: 'Georgia', serif;
    font-size: 32px;
    font-weight: 900;
    color: white;
    letter-spacing: 1px;
    margin: 0;
    text-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  .cert-subtitle{
    font-size: 13px;
    color: #d1fae5;
    margin-top: 8px;
    font-weight: 500;
  }

  .cert-body{
    padding: 32px 28px;
  }

  .cert-photos{
    display: grid;
    grid-template-columns: 120px 1fr 120px;
    gap: 20px;
    margin-bottom: 28px;
    align-items: center;
  }

  .cert-photo-frame{
    width: 120px;
    height: 120px;
    border-radius: 12px;
    border: 3px solid #d1d5db;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .cert-photo-frame img{
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cert-photo-label{
    text-align: center;
    font-size: 11px;
    color: #64748b;
    margin-top: 6px;
    font-weight: 700;
  }

  .cert-artwork-main{
    border-radius: 14px;
    overflow: hidden;
    border: 3px solid #e5e7eb;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  }

  .cert-artwork-main img{
    width: 100%;
    height: auto;
    display: block;
  }

  .cert-qr{
    width: 120px;
    height: 120px;
    border: 3px solid #047857;
    border-radius: 12px;
    padding: 8px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cert-info-panel{
    background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    border: 2px solid #a7f3d0;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    border-left: 6px solid #10b981;
  }

  .cert-info-title{
    font-family: 'Georgia', serif;
    font-size: 18px;
    font-weight: 900;
    color: #064e3b;
    margin-bottom: 16px;
  }

  .cert-info-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px 20px;
  }

  .cert-info-item{
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .cert-info-label{
    font-size: 11px;
    font-weight: 800;
    color: #047857;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .cert-info-value{
    font-size: 14px;
    font-weight: 700;
    color: #0f172a;
  }

  .cert-hash-panel{
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .cert-hash-title{
    font-size: 12px;
    font-weight: 900;
    color: #475569;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .cert-hash-value{
    font-family: 'Courier New', monospace;
    font-size: 11px;
    color: #1e293b;
    word-break: break-all;
    line-height: 1.6;
    background: white;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }

  .cert-footer{
    padding-top: 20px;
    border-top: 2px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
  }

  .cert-stamp{
    width: 90px;
    height: 90px;
    border: 4px double #047857;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 900;
    color: #047857;
    transform: rotate(-15deg);
    background: radial-gradient(circle, #ecfdf5 0%, #d1fae5 100%);
  }

  .cert-disclaimer{
    font-family: 'Georgia', serif;
    font-size: 11px;
    line-height: 1.6;
    color: #475569;
    text-align: center;
    font-style: italic;
    padding: 16px 20px;
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    margin-top: 20px;
  }

  @media (max-width: 720px){
    .dn-wrap{ padding: 22px; }
    .dn-grid{ grid-template-columns: 1fr; }
    .cert-photos{ grid-template-columns: 1fr; }
    .cert-photo-frame{ margin: 0 auto; }
    .cert-info-grid{ grid-template-columns: 1fr; }
  }
</style>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
(async function () {
  const SUPABASE_URL = "https://immdfdvrwqcvgmflbgdr.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltbWRmZHZyd3FjdmdtZmxiZ2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NzU0MTgsImV4cCI6MjA4MzQ1MTQxOH0.MN05h2FLVFb14P9Oi0y3g3euqZjzGdVslJay6aQ1HkE";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const sealBtn = document.getElementById("sealBtn");
  const artFile = document.getElementById("artFile");
  const userPhoto = document.getElementById("userPhoto");
  const creatorName = document.getElementById("creatorName");
  const artTitle = document.getElementById("artTitle");
  const maskOption = document.getElementById("maskOption");
  const visibility = document.getElementById("visibility");
  const statusBox = document.getElementById("statusBox");

  const artDrop = document.getElementById("artDrop");
  const photoDrop = document.getElementById("photoDrop");
  const artMeta = document.getElementById("artMeta");
  const photoMeta = document.getElementById("photoMeta");

  const artPreview = document.getElementById("artPreview");
  const photoPreview = document.getElementById("photoPreview");
  const artPreviewEmpty = document.getElementById("artPreviewEmpty");
  const photoPreviewEmpty = document.getElementById("photoPreviewEmpty");

  const previewSection = document.getElementById("previewSection");
  const certPreview = document.getElementById("certPreview");
  const downloadPNG = document.getElementById("downloadPNG");
  const downloadJSON = document.getElementById("downloadJSON");
  const downloadPDF = document.getElementById("downloadPDF");

  let currentRecord = null;
  let currentArtDataUrl = null;
  let currentPhotoDataUrl = null;

  // UI helpers
  function setStatus(html, kind = "info") {
    statusBox.style.display = "block";
    const color = kind === "error" ? "#dc2626" : (kind === "ok" ? "#059669" : "#475569");
    statusBox.innerHTML = `<span style="color:${color};">${html}</span>`;
  }

  function setDropMeta(el, file) {
    if (!file) { el.textContent = ""; return; }
    const sizeMb = (file.size / (1024 * 1024)).toFixed(2);
    el.textContent = `${file.name} ‚Ä¢ ${sizeMb} MB`;
  }

  function bindDropZone(zoneEl, inputEl, metaEl, onFile) {
    zoneEl.addEventListener("click", () => inputEl.click());
    zoneEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") inputEl.click();
    });

    ["dragenter","dragover"].forEach(evt => {
      zoneEl.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoneEl.classList.add("is-over");
      });
    });
    ["dragleave","drop"].forEach(evt => {
      zoneEl.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoneEl.classList.remove("is-over");
      });
    });
    zoneEl.addEventListener("drop", (e) => {
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!file) return;
      inputEl.files = e.dataTransfer.files;
      setDropMeta(metaEl, file);
      onFile(file);
    });

    inputEl.addEventListener("change", () => {
      const file = inputEl.files && inputEl.files[0];
      setDropMeta(metaEl, file);
      onFile(file);
    });
  }

  bindDropZone(photoDrop, userPhoto, photoMeta, async (file) => {
    if (!file) return;
    if (!file.type.startsWith("image/")) {
      photoPreview.style.display = "none";
      photoPreviewEmpty.textContent = "Sadece g√∂rsel kabul edilir";
      photoPreviewEmpty.style.display = "block";
      return;
    }
    const url = URL.createObjectURL(file);
    photoPreview.src = url;
    photoPreview.style.display = "block";
    photoPreviewEmpty.style.display = "none";
  });

  bindDropZone(artDrop, artFile, artMeta, async (file) => {
    if (!file) return;
    if (file.type.startsWith("image/")) {
      const url = URL.createObjectURL(file);
      artPreview.src = url;
      artPreview.style.display = "block";
      artPreviewEmpty.style.display = "none";
    } else {
      artPreview.style.display = "none";
      artPreviewEmpty.textContent = "G√∂rsel deƒüilse √∂nizleme yok";
      artPreviewEmpty.style.display = "block";
    }
  });

  // Crypto
  async function digest(buffer, algo) {
    const hashBuffer = await crypto.subtle.digest(algo, buffer);
    return Array.from(new Uint8Array(hashBuffer)).map((b) => b.toString(16).padStart(2, "0")).join("");
  }

  function maskIP(ip) {
    if (!ip) return "Korumalƒ±";
    const parts = ip.split('.');
    if (parts.length === 4) return `${parts[0]}.${parts[1]}.***.***`;
    return ip.substring(0, 6) + "****";
  }

  function maskLoc(city, country) {
    return `*** / ${country || "Bilinmiyor"}`;
  }

  async function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("FileReader failed"));
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }

  function formatDate(iso) {
    try {
      const d = new Date(iso);
      return d.toLocaleDateString('tr-TR') + ' ' + d.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
    } catch {
      return iso;
    }
  }

  // Generate QR
  async function generateQR(text) {
    const canvas = document.createElement("canvas");
    await QRCode.toCanvas(canvas, text, {
      width: 110,
      color: { dark: "#064e3b", light: "#ffffff" }
    });
    return canvas.toDataURL("image/png");
  }

  // Generate Certificate HTML
  async function generateCertHTML(record, artDataUrl, photoDataUrl, qrDataUrl) {
    const photoHTML = photoDataUrl ? `
      <div>
        <div class="cert-photo-frame">
          <img src="${photoDataUrl}" alt="User">
        </div>
        <div class="cert-photo-label">Fotoƒüraf</div>
      </div>
    ` : '';

    const artHTML = artDataUrl ? `
      <div class="cert-artwork-main">
        <img src="${artDataUrl}" alt="Artwork">
      </div>
    ` : `
      <div class="cert-artwork-main" style="min-height: 200px; display: flex; align-items: center; justify-content: center; background: #f8fafc;">
        <div style="text-align: center; color: #64748b;">
          <div style="font-size: 48px; margin-bottom: 8px;">üìÑ</div>
          <div style="font-weight: 700;">${record.title}</div>
        </div>
      </div>
    `;

    return `
      <div class="cert-frame">
        <div class="cert-header">
          <div class="cert-logo">POART PROTOCOL</div>
          <h2 class="cert-title">Dƒ∞Jƒ∞TAL NOTER SERTƒ∞Fƒ∞KASI</h2>
          <div class="cert-subtitle">ƒ∞lhan Art Gallery tarafƒ±ndan verilmi≈ütir</div>
        </div>

        <div class="cert-body">
          <div class="cert-photos">
            ${photoHTML}
            ${artHTML}
            <div>
              <div class="cert-qr">
                <img src="${qrDataUrl}" style="width: 100%; height: auto;" alt="QR">
              </div>
              <div class="cert-photo-label">Doƒürula</div>
            </div>
          </div>

          <div class="cert-info-panel">
            <div class="cert-info-title">Sertifika Bilgileri</div>
            <div class="cert-info-grid">
              <div class="cert-info-item">
                <div class="cert-info-label">Eser Adƒ±</div>
                <div class="cert-info-value">${record.title}</div>
              </div>
              <div class="cert-info-item">
                <div class="cert-info-label">Sanat√ßƒ±</div>
                <div class="cert-info-value">${record.creator}</div>
              </div>
              <div class="cert-info-item">
                <div class="cert-info-label">Sertifika ID</div>
                <div class="cert-info-value">${record.cert_id}</div>
              </div>
              <div class="cert-info-item">
                <div class="cert-info-label">Tarih</div>
                <div class="cert-info-value">${formatDate(record.created_at)}</div>
              </div>
              <div class="cert-info-item">
                <div class="cert-info-label">G√∂r√ºn√ºrl√ºk</div>
                <div class="cert-info-value">${record.visibility}</div>
              </div>
              <div class="cert-info-item">
                <div class="cert-info-label">Konum</div>
                <div class="cert-info-value">${record.location_data}</div>
              </div>
            </div>
          </div>

          <div class="cert-hash-panel">
            <div class="cert-hash-title">üîê Kriptografik Parmak ƒ∞zleri</div>
            <div style="margin-bottom: 10px;">
              <div style="font-size: 10px; font-weight: 800; color: #64748b; margin-bottom: 4px;">SHA-256:</div>
              <div class="cert-hash-value">${record.sha256}</div>
            </div>
            <div>
              <div style="font-size: 10px; font-weight: 800; color: #64748b; margin-bottom: 4px;">SHA-512:</div>
              <div class="cert-hash-value">${record.sha512}</div>
            </div>
          </div>

          <div class="cert-disclaimer">
            This certificate is digitally notarized and cryptographically sealed for the first stage of verification on the PoArt Protocol. Please check the site for second-stage verification.
          </div>

          <div class="cert-footer">
            <div class="cert-stamp">
              ONAYLANDI<br>‚úì
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Main seal function
  sealBtn.addEventListener("click", async () => {
    if (!artFile.files.length) return alert("L√ºtfen √∂nce bir eser se√ßin!");

    previewSection.style.display = "none";
    certPreview.innerHTML = "";

    try {
      sealBtn.disabled = true;
      setStatus("‚è≥ ƒ∞≈üleniyor... Hash hesaplanƒ±yor...", "info");

      const file = artFile.files[0];
      const buffer = await file.arrayBuffer();

      const sha256 = await digest(buffer, "SHA-256");
      const sha512 = await digest(buffer, "SHA-512");

      // IP & location
      let ip = "Bilinmiyor", loc = "Bilinmiyor";
      try {
        const ipRes = await fetch("https://ipapi.co/json/");
        const data = await ipRes.json();
        const shouldMask = maskOption.checked || visibility.value === "masked";
        ip = shouldMask ? maskIP(data.ip) : data.ip;
        loc = shouldMask ? maskLoc(data.city, data.country_name) : `${data.city}, ${data.country_name}`;
      } catch (e) {
        console.warn("IP fetch failed:", e);
      }

      const record = {
        cert_id: "POART-" + Math.random().toString(36).substring(2, 10).toUpperCase(),
        title: artTitle.value || "ƒ∞simsiz",
        creator: creatorName.value || "Bilinmiyor",
        sha256: sha256,
        sha512: sha512,
        visibility: visibility.value,
        device_info: navigator.userAgent,
        location_data: loc,
        origin_ip: ip,
        created_at: new Date().toISOString()
      };

      currentRecord = record;

      // Convert images to data URLs
      if (file.type.startsWith("image/")) {
        currentArtDataUrl = await fileToDataUrl(file);
      } else {
        currentArtDataUrl = null;
      }

      const userFile = userPhoto.files[0];
      if (userFile && userFile.type.startsWith("image/")) {
        currentPhotoDataUrl = await fileToDataUrl(userFile);
      } else {
        currentPhotoDataUrl = null;
      }

      // CRITICAL FIX: Always try Supabase insert, regardless of visibility
      setStatus("üíæ Supabase'e kaydediliyor...", "info");
      let supabaseSuccess = false;
      try {
        // Remove .select() to avoid RLS read restrictions
        const { error } = await sb.from("manifests").insert([record]);
        if (error) {
          console.error("‚ùå Supabase error:", error);
          console.error("Error details:", JSON.stringify(error, null, 2));
          throw error;
        }
        console.log("‚úÖ Supabase insert SUCCESS:", record.cert_id);
        supabaseSuccess = true;
      } catch (e) {
        console.error("‚ùå Supabase insert FAILED:", e);
        console.error("Record attempted:", JSON.stringify(record, null, 2));
        setStatus(`‚ö†Ô∏è Supabase kayƒ±t hatasƒ±: ${e.message || e.toString()}. Sertifika yine de olu≈üturuluyor...`, "info");
      }

      // Generate QR
      const qrDataUrl = await generateQR(`https://ilhanart.org/verify?id=${record.cert_id}`);

      // Generate certificate HTML
      setStatus("üìú Sertifika olu≈üturuluyor...", "info");
      const certHTML = await generateCertHTML(record, currentArtDataUrl, currentPhotoDataUrl, qrDataUrl);
      certPreview.innerHTML = certHTML;
      previewSection.style.display = "block";

      if (supabaseSuccess) {
        setStatus("‚úÖ Sertifika hazƒ±r ve Supabase'e kaydedildi! ƒ∞ndirme se√ßeneklerini kullanabilirsiniz.", "ok");
      } else {
        setStatus("‚ö†Ô∏è Sertifika hazƒ±r ama Supabase kayƒ±t ba≈üarƒ±sƒ±z. (RLS policy sorunu olabilir - INSERT policy ekleyin)", "ok");
      }
    } catch (err) {
      console.error("Main error:", err);
      setStatus(`‚ùå Hata: ${err.message}`, "error");
    } finally {
      sealBtn.disabled = false;
    }
  });

  // Download PNG
  downloadPNG.addEventListener("click", async () => {
    if (!currentRecord) return;
    try {
      setStatus("üñºÔ∏è PNG olu≈üturuluyor...", "info");
      const certElement = certPreview.querySelector('.cert-frame');
      const canvas = await html2canvas(certElement, { 
        scale: 2, 
        useCORS: true, 
        backgroundColor: '#ffffff',
        logging: false
      });
      const link = document.createElement("a");
      link.download = `${currentRecord.cert_id}_Certificate.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
      setStatus("‚úÖ PNG indirildi!", "ok");
    } catch (e) {
      console.error(e);
      setStatus("‚ùå PNG olu≈üturma hatasƒ±", "error");
    }
  });

  // Download JSON
  downloadJSON.addEventListener("click", () => {
    if (!currentRecord) return;
    const jsonData = {
      ...currentRecord,
      verification_url: `https://ilhanart.org/verify?id=${currentRecord.cert_id}`
    };
    const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: "application/json" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${currentRecord.cert_id}_Data.json`;
    link.click();
    setStatus("‚úÖ JSON indirildi!", "ok");
  });

  // Download PDF
  downloadPDF.addEventListener("click", async () => {
    if (!currentRecord) return;
    try {
      setStatus("üìÑ PDF olu≈üturuluyor...", "info");
      const { jsPDF } = window.jspdf;
      if (!jsPDF) throw new Error("jsPDF y√ºklenmedi");

      const certElement = certPreview.querySelector('.cert-frame');
      const canvas = await html2canvas(certElement, { 
        scale: 2, 
        useCORS: true, 
        backgroundColor: '#ffffff' 
      });

      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p", "mm", "a4");
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      
      const imgWidth = pdfWidth - 20;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
      pdf.save(`${currentRecord.cert_id}_Certificate.pdf`);
      setStatus("‚úÖ PDF indirildi!", "ok");
    } catch (e) {
      console.error(e);
      setStatus("‚ùå PDF olu≈üturma hatasƒ±", "error");
    }
  });
})();
</script>
