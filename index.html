<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>[PoArt] Digital Notary v1.5</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>

<div class="page">
  <h1>[PoArt] Digital Notary v1.5</h1>
  <p class="subtitle">Matematiksel delil Ã¼ret, gizliliÄŸini seÃ§, kaydÄ±nÄ± sen yÃ¶net.</p>

  <div class="upload-section">
    <label>ğŸ–¼ï¸ File to Seal</label>
    <input type="file" id="fileInput" />
  </div>

  <div class="info-section">
    <label>ğŸ§  Title</label>
    <input type="text" id="title" placeholder="Example: Manifesto v1.0">

    <label>âœï¸ Creator</label>
    <input type="text" id="creator" placeholder="Name or pseudonym">

    <label>ğŸ·ï¸ Description</label>
    <textarea id="description" placeholder="Short note or context..."></textarea>

    <label>ğŸ”’ Visibility</label>
    <select id="visibility">
      <option value="local">ğŸ“ Only on this device</option>
      <option value="private">â˜ï¸ Cloud (private record)</option>
      <option value="public">ğŸŒ Public Registry</option>
    </select>
  </div>

  <button id="sealBtn">ğŸ’¾ Seal & Save</button>
  <div id="status"></div>
</div>

<script>
(async function() {
  // === Supabase client ===
  const SUPABASE_URL = 'https://immdfdvrwqcvgmflbgdr.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltbWRmZHZyd3FjdmdtZmxiZ2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NzU0MTgsImV4cCI6MjA4MzQ1MTQxOH0.MN05h2FLVFb14P9Oi0y3g3euqZjzGdVslJay6aQ1HkE';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // === DOM elements ===
  const fileInput = document.getElementById('fileInput');
  const sealBtn = document.getElementById('sealBtn');
  const statusEl = document.getElementById('status');

  let currentFile = null, fileHashes = { sha256: null, sha512: null };

  fileInput.addEventListener('change', e => {
    if (e.target.files.length) currentFile = e.target.files[0];
  });

  function setStatus(msg, cls="") {
    statusEl.textContent = msg;
    statusEl.className = cls;
  }

  async function hashBuffer(buffer, algo) {
    const hashBuffer = await crypto.subtle.digest(algo, buffer);
    return Array.from(new Uint8Array(hashBuffer))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }

  function getDeviceInfo() {
    const ua = navigator.userAgent;
    const os = ua.includes('Win') ? 'Windows' :
               ua.includes('Mac') ? 'MacOS' :
               ua.includes('Linux') ? 'Linux' :
               ua.includes('Android') ? 'Android' :
               ua.includes('iPhone') ? 'iOS' : 'Unknown';
    const browser = ua.includes('Chrome') ? 'Chrome' :
                    ua.includes('Safari') ? 'Safari' :
                    ua.includes('Firefox') ? 'Firefox' :
                    ua.includes('Edg') ? 'Edge' : 'Browser';
    return `${os} â€¢ ${browser}`;
  }

  sealBtn.addEventListener('click', async () => {
    const visibility = document.getElementById('visibility').value;
    const title = document.getElementById('title').value || "Untitled";
    const creator = document.getElementById('creator').value || "Anonymous";
    const desc = document.getElementById('description').value || "";
    const certId = "POART-" + Date.now().toString(36).toUpperCase();
    const device = getDeviceInfo();

    if (!currentFile) return setStatus("Please select a file first.", "error");

    setStatus("ğŸ”„ Processing file...", "loading");

    try {
      const buffer = await currentFile.arrayBuffer();
      fileHashes.sha256 = await hashBuffer(buffer, "SHA-256");
      fileHashes.sha512 = await hashBuffer(buffer, "SHA-512");

      const manifest = {
        id: certId,
        title,
        creator,
        description: desc,
        hash256: fileHashes.sha256,
        hash512: fileHashes.sha512,
        device,
        visibility,
        timestamp: new Date().toISOString()
      };

      if (visibility === "local") {
        localStorage.setItem(certId, JSON.stringify(manifest));
        setStatus("âœ… Saved locally only.", "success");
      }
      else if (visibility === "private") {
        const { error } = await supabase.from("manifests_private").insert([manifest]);
        if (error) throw error;
        setStatus("âœ… Saved privately in cloud.", "success");
      }
      else if (visibility === "public") {
        const { error } = await supabase.from("manifests_public").insert([manifest]);
        if (error) throw error;
        setStatus("ğŸŒ Published publicly on PoArt Registry.", "success");
      }

      // Optional local backup
      localStorage.setItem("lastManifest", JSON.stringify(manifest));
    } catch (err) {
      console.error(err);
      setStatus("âŒ Error: " + err.message, "error");
    }
  });
})();
</script>

<style>
body { font-family: Inter, sans-serif; background: #f8fafc; color: #1e293b; margin: 0; padding: 20px; }
.page { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
h1 { font-size: 22px; font-weight: 900; color: #059669; margin-bottom: 10px; }
.subtitle { font-size: 13px; color: #64748b; margin-bottom: 20px; }
.upload-section, .info-section { margin-bottom: 20px; }
label { font-size: 13px; font-weight: 700; color: #047857; display: block; margin-top: 10px; }
input, textarea, select { width: 100%; margin-top: 5px; padding: 10px 12px; border: 1px solid #d1fae5; border-radius: 8px; font-size: 14px; outline: none; }
textarea { resize: vertical; min-height: 70px; }
button { width: 100%; padding: 14px; background: linear-gradient(135deg,#10b981,#047857); color: white; font-weight: 800; border: none; border-radius: 10px; cursor: pointer; transition: .2s; }
button:hover { transform: translateY(-1px); }
#status { margin-top: 15px; font-weight: 700; text-align: center; }
.loading { color: #0f766e; }
.success { color: #065f46; }
.error { color: #b91c1c; }
</style>

</body>
</html>
