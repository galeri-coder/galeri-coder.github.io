<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dijital Noter | PoArt Registry</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

  <!-- Styles -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: transparent;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    .container {
      width: 100%;
      max-width: 720px;
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin: 0 auto;
    }

    h1 {
      font-weight: 800;
      color: #047857;
      font-size: 26px;
      margin-bottom: 24px;
      text-align: center;
      letter-spacing: -0.5px;
    }

    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #1f2937;
      font-size: 13px;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      background: #fafafa;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #10b981;
      background: white;
      outline: none;
      box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
    }

    input[type="file"] {
      padding: 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: #f9fafb;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkbox-container:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .checkbox-container input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #10b981;
    }

    .checkbox-container label {
      margin: 0;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      text-transform: none;
      letter-spacing: normal;
      cursor: pointer;
      flex: 1;
    }

    button {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #047857, #10b981);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 15px;
      letter-spacing: 0.3px;
      box-shadow: 0 4px 12px rgba(16,185,129,0.25);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16,185,129,0.35);
    }

    button:active {
      transform: translateY(0);
    }

    .output {
      display: none;
      background: linear-gradient(135deg, #ecfdf5, #f0fdf4);
      border-radius: 14px;
      border: 2px solid #a7f3d0;
      padding: 24px;
      margin-top: 24px;
    }

    .output h3 {
      color: #047857;
      font-size: 18px;
      margin-bottom: 16px;
      font-weight: 800;
    }

    .photo-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    .preview-img {
      width: 100px;
      height: 100px;
      border-radius: 10px;
      object-fit: cover;
      border: 2px solid #d1d5db;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .info-item {
      background: white;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 3px solid #10b981;
    }

    .info-item strong {
      color: #047857;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .hash-box {
      background: white;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      padding: 12px;
      border-radius: 8px;
      word-break: break-all;
      margin-bottom: 8px;
      color: #475569;
      border: 1px solid #e5e7eb;
    }

    #qrcode {
      display: flex;
      justify-content: center;
      margin: 16px 0;
      padding: 12px;
      background: white;
      border-radius: 10px;
    }

    .download-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 16px;
    }

    .download-buttons button {
      font-size: 13px;
      padding: 12px;
    }

    #certHidden {
      position: absolute;
      left: -9999px;
      top: -9999px;
    }

    /* Squarespace iframe fix */
    @media screen and (max-width: 768px) {
      .container {
        padding: 20px;
        border-radius: 12px;
      }

      h1 {
        font-size: 22px;
      }

      .download-buttons {
        grid-template-columns: 1fr;
      }

      .preview-img {
        width: 80px;
        height: 80px;
      }
    }

    @media screen and (max-width: 480px) {
      .container {
        padding: 16px;
      }

      h1 {
        font-size: 20px;
      }

      input[type="text"],
      input[type="file"],
      select {
        font-size: 13px;
        padding: 10px 12px;
      }

      button {
        font-size: 14px;
        padding: 13px;
      }
    }

  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“œ Dijital Noter</h1>

    <div class="form-group">
      <label>Eser AdÄ±</label>
      <input type="text" id="title" placeholder="Ã–rn. Sonsuzluk">
    </div>

    <div class="form-group">
      <label>OluÅŸturucu AdÄ±</label>
      <input type="text" id="creator" placeholder="Ã–rn. Ä°lhan Art">
    </div>

    <div class="form-group">
      <label>Eser GÃ¶rseli</label>
      <input type="file" id="artFile" accept="image/*">
    </div>

    <div class="form-group">
      <label>KiÅŸisel FotoÄŸraf (isteÄŸe baÄŸlÄ±)</label>
      <input type="file" id="profileFile" accept="image/*">
    </div>

    <div class="form-group">
      <label>GÃ¶rÃ¼nÃ¼rlÃ¼k</label>
      <select id="visibility">
        <option value="public">Herkese AÃ§Ä±k (Public Registry)</option>
        <option value="private">Sadece Benim TarayÄ±cÄ±mda</option>
        <option value="masked">Anonim / Maskeleme Aktif</option>
      </select>
    </div>

    <div class="checkbox-container">
      <input type="checkbox" id="maskLocation">
      <label for="maskLocation">IP adresim ve konumum maskelenerek gÃ¶rÃ¼nsÃ¼n</label>
    </div>

    <button id="generateBtn">SertifikayÄ± OluÅŸtur</button>

    <div class="output" id="outputBox">
      <h3>âœ… Sertifika OluÅŸturuldu</h3>
      <div class="photo-row">
        <img id="artPreview" class="preview-img" src="" alt="">
        <img id="profilePreview" class="preview-img" src="" alt="" style="display:none">
      </div>
      <div class="info-item">
        <strong>Sertifika ID:</strong> <span id="certId"></span>
      </div>
      <div class="hash-box"><strong>SHA-256:</strong><br><span id="hash256"></span></div>
      <div class="hash-box"><strong>SHA-512:</strong><br><span id="hash512"></span></div>
      <div id="qrcode"></div>
      <div class="download-buttons">
        <button id="downloadCert">ðŸ“œ PNG Ä°ndir</button>
        <button id="downloadJson">ðŸ’¾ JSON Ä°ndir</button>
      </div>
    </div>
  </div>

  <div id="certHidden"></div>

<script>
const SUPABASE_URL = "https://immdfdvrwqcvgmflbgdr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltbWRmZHZyd3FjdmdtZmxiZ2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NzU0MTgsImV4cCI6MjA4MzQ1MTQxOH0.MN05h2FLVFb14P9Oi0y3g3euqZjzGdVslJay6aQ1HkE";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function hashFile(file, algo="SHA-512") {
  const buf = await file.arrayBuffer();
  const digest = await crypto.subtle.digest(algo, buf);
  return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2,"0")).join("");
}

async function getForensicData() {
  try {
    const response = await fetch('https://ipapi.co/json/');
    const data = await response.json();
    return {
      ip: data.ip || 'Bilinmiyor',
      city: data.city || 'Bilinmiyor',
      region: data.region || 'Bilinmiyor',
      country: data.country_name || 'Bilinmiyor'
    };
  } catch(e) {
    return {
      ip: 'VPN/Gizli',
      city: 'Bilinmiyor',
      region: 'Bilinmiyor',
      country: 'Bilinmiyor'
    };
  }
}

document.getElementById("generateBtn").onclick = async () => {
  const art = document.getElementById("artFile").files[0];
  if (!art) return alert("LÃ¼tfen eser gÃ¶rseli seÃ§in.");
  
  const title = document.getElementById("title").value || "Ä°simsiz Eser";
  const creator = document.getElementById("creator").value || "Bilinmiyor";
  const profile = document.getElementById("profileFile").files[0] || null;
  const visibility = document.getElementById("visibility").value;
  const maskLoc = document.getElementById("maskLocation").checked;

  const sha256 = await hashFile(art, "SHA-256");
  const sha512 = await hashFile(art, "SHA-512");
  const certId = "POART-" + Math.random().toString(36).substring(2,10).toUpperCase();

  const forensicData = await getForensicData();
  
  // Maskeleme mantÄ±ÄŸÄ±
  let locationDisplay, ipDisplay;
  if (maskLoc) {
    locationDisplay = `*** / ${forensicData.region} / ${forensicData.country}`;
    ipDisplay = "KorumalÄ±";
  } else {
    locationDisplay = `${forensicData.city} / ${forensicData.region} / ${forensicData.country}`;
    ipDisplay = forensicData.ip;
  }

  // GÃ¶rsel Ã¶nizleme
  document.getElementById("artPreview").src = URL.createObjectURL(art);
  if (profile) {
    document.getElementById("profilePreview").src = URL.createObjectURL(profile);
    document.getElementById("profilePreview").style.display = 'block';
  }

  const manifest = {
    cert_id: certId,
    title: title,
    creator: creator,
    sha256: sha256,
    sha512: sha512,
    device_info: navigator.platform + ' â€¢ ' + navigator.userAgent.split(' ').pop(),
    visibility: visibility,
    location_data: locationDisplay,
    origin_ip: ipDisplay,
    created_at: new Date().toISOString()
  };

  // public ise Supabase'e gÃ¶nder
  if (visibility === "public") {
    try {
      await sb.from("manifests").insert([manifest]);
    } catch(e) {
      console.error("Supabase error:", e);
    }
  }

  document.getElementById("outputBox").style.display = "block";
  document.getElementById("certId").textContent = certId;
  document.getElementById("hash256").textContent = sha256;
  document.getElementById("hash512").textContent = sha512;

  // QR kod
  document.getElementById("qrcode").innerHTML = "";
  new QRCode(document.getElementById("qrcode"), {
    text: `https://galeri-coder.github.io/verify.html?q=${encodeURIComponent(certId)}`,
    width: 120, 
    height: 120, 
    colorDark: "#047857",
    colorLight: "#ffffff"
  });

  // PNG indir
  document.getElementById("downloadCert").onclick = async () => {
    const clone = document.getElementById("outputBox").cloneNode(true);
    clone.style.display = "block";
    clone.style.maxWidth = "700px";
    clone.style.margin = "20px";
    document.getElementById("certHidden").innerHTML = "";
    document.getElementById("certHidden").appendChild(clone);
    const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
    const link = document.createElement("a");
    link.download = `${certId}.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
  };

  // JSON indir
  document.getElementById("downloadJson").onclick = () => {
    const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: "application/json" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${certId}.json`;
    link.click();
  };

  // SayfayÄ± yukarÄ± kaydÄ±r
  document.getElementById("outputBox").scrollIntoView({ behavior: 'smooth', block: 'start' });
};
</script>
</body>
</html>
